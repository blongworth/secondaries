---
title: "Secondary Fliers"
output:
  html_document: default
  html_notebook: default
  pdf_document: default
---

Load secondary data. Select dates 2016 or newer. Select size > 8 um and
fraction modern > 0.1. Using data from no_os and standards listed in 
standards table.
```{r, message = FALSE}
#Load Libraries
library(dplyr)
library(ggplot2)
library(knitr)
library(amstools)
library(lubridate)
library(tidyr)

#set parameters
from <- '2014-01-01'
to <- 'present' #present or date
sys <- 'both' #cfams, usams, ams1 or both
size <- c(80,300)
sigcut <- 3 # cutoff value for sigma

#Set digits for output
options(digits=4)

#Load QC data from file
load("qcData.rda")

#Filter data
out <- std %>%
  mutate(runtime = as.Date(runtime)) %>%
  filter(primary == FALSE, # rec_num != 113385, #don't use normalizing ox-I
         fm_consensus > .1,
         runtime >= as.Date(from),
         runtime <= ifelse(to != 'present', to, Sys.Date()),
         gf_co2_qty > size[1], gf_co2_qty < size[2], #Select size range
         #system == "CFAMS",
         #lab == "WAT", #Use only samples from the SPL
         sigma < 20,
         frep_err < .10,
         is.na(q_flag) #Check for q_flag
  ) %>%
  mutate(year = year(runtime),
         month = month(runtime), 
         sigav = sigma(f_modern, fm_consensus, totErr(rep_err, 0.0026, f_modern))) %>%
  arrange(year, month, lab, system)
#write.csv(out, "standards.csv")
```

### Summarize by month

* Data are fraction of all secondaries > `r sigcut` sigma

```{r}

out.s <- out %>% group_by(year, month, lab, system) %>% 
  summarise(hisig = sum(abs(sigma) > sigcut),
            hisigav = sum(abs(sigav) > sigcut),
            count = n()) %>%
  mutate(hisigf = hisig/count,
         hisigavf = hisigav/count,
         date = as.factor(mdy(sprintf('%s %s %s', month, "1", year))))

kable(out.s)
#out.s %>% select(year, month, system, hisigf) %>% 
#  spread(system, hisigf) %>%
#  knitr::kable(caption = "Fraction of sigma > 3 by month")

```

### Overall summary

"hisig" is number of secondaries > `r sigcut` sigma, columns with "av" include
added variance. Columns ending in "f" are fraction greater than `r sigcut` sigma.

```{r}

out %>% 
  group_by(system, lab) %>%
  summarise(hisig = sum(abs(sigma) > sigcut),
            hisigav = sum(abs(sigav) > sigcut),
            count = n(),
            err = mean(frep_err)) %>%
  mutate(hisigf = hisig/count,
         hisigavf = hisigav/count) %>%
  kable(caption = paste("Secondaries >", sigcut, "sigma, 2016 to present"))
```

### Plots

* Bars are fraction of secondaries greater than `r sigcut` sigma by month and system

```{r}
ggplot(out.s, aes(date, hisigf)) + 
  #geom_bar(aes(fill = system), stat = "identity", position = "dodge") +
  geom_point(aes(shape = system, color = system), size = 3) +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  facet_grid(lab ~ .) +
    ggtitle(paste("Fraction of secondaries >", sigcut, "sigma"))
```

```{r}
ggplot(out.s, aes(date, hisigavf)) + 
  #geom_bar(aes(fill = system), stat = "identity", position = "dodge") +
  geom_point(aes(shape = system, color = system), size = 3) +
  facet_grid(lab ~ .) +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle(paste("Fraction of secondaries >", sigcut,"sigma"), subtitle = "With added variance of 0.026 * Fm")
```
