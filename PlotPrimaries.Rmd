---
output: html_document
---
Primary standard analysis
========================================================

`r as.character(format(Sys.Date(), format="%B %d, %Y"))`





```{r Setup, echo=FALSE, warning=FALSE, message=FALSE}

#Load Libraries
library(ggplot2)
library(plyr)
library(dplyr)
library(knitr)
library(RODBC)

#Load files
source("~/R/dbconfig.R") #DB connection info
source("CalculateSecondaries.R") #Functions

#set parameters- from, to, sys not used if loading from file
#from <- '2014-09-01'
#to <- 'present' #present or date
#sys <- 'both' #cfams, usams, ams1 or both
size <- c(40,300)

#Set digits for output
options(digits=4)

# Get fresh secondary data
#out <- getQCData(from, to, sys)

#Load QC data from file
load("qcData.rda")

#Filter data
out.s <- filter(out, rec_num == 113385, #look at normalizing ox-I
                 f_modern > .1, f_modern < 1.6,
                 gf_co2_qty > size[1], gf_co2_qty < size[2]) #Select size range
                 
```

Analysis of performance of primary standards for `r sys` from `r from` to `r to`. Sample size is from `r size[1]` to `r size[2]`umol, outliers have been removed by sigma (-10 to 10) and normalized Fm (-0.02 to 0.02).

* Mean Sigma for USAMS is `r mean(out.s$sigma[out.s$system=="USAMS"])`.
* Mean Sigma for CFAMS is `r mean(out.s$sigma[out.s$system=="CFAMS"])`.

Normalized fm difference is defined as:

$\frac{Fm_{m}-Fm_{c}}{Fm_{c}}$

where $Fm_{m}$ is measured Fm and $Fm_{c}$ is consensus Fm.


# Summary table


```{r, echo=FALSE, message=FALSE, results='asis'}

#Make summary table
secsum <- ddply(out.s, .(name, system), summarize,
                fm.e = mean(fm_consensus),
                fm = mean(f_modern),
                fm.s = sd(f_modern),
                sig = mean(sigma),
                sig.s = sd(sigma),
                merr.m = mean(merr),
                intrerr = intrErr(sd(f_modern), mean(merr)),
                N = length(f_modern))


knitr::kable(secsum, digits = 4, caption = "Summary data for all primaries")

#Make summary table
out.s$month <- ordered(months(out.s$tp_date_pressed), c("September","October","November","December","January", "February", "March"))
monthsum <- ddply(out.s, .(system, month), summarize,
                fm.e = mean(fm_consensus),
                fm = mean(f_modern),
                fm.s = sd(f_modern),
                sig = mean(sigma),
                sig.s = sd(sigma),
                merr.m = mean(merr),
                intrerr = intrErr(sd(f_modern), mean(merr)),
                N = length(f_modern))

knitr::kable(monthsum, digits = 4, caption = "Summary data for all primaries by month")


```

# Plots of primary error by month

Looks like CFAMS is getting better while USAMS gets progressively worse. No idea why. Any difference in picking standards? Any chance one system gets the first "scoop" and the other gets the second? More likely the answer is drifting tunes on both systems.

I think the downward jump in reported error (second plot) is when CFAMS increased it's number of runs/target to 10 to match USAMS. The final 2 plots show ratio of external to internal error and external error. Interestingly, the increased number of runs decreased external error while not doing much to internal error... Does this make sense?

``` {r plots}
ggplot(data=monthsum, aes(x=month, y=fm.s, fill=system)) + 
  geom_bar(stat="identity", position=position_dodge(), colour="black") + 
  ggtitle("SD of OX-I by month")

ggplot(data=monthsum, aes(x=month, y=merr.m, fill=system)) + 
  geom_bar(stat="identity", position=position_dodge(), colour="black") +
  coord_cartesian(ylim = c(0.002, 0.004)) +
  ggtitle("reported error of OX-I by month")

ggplot(data=out.s, aes(x=month, y=f_ext_error/f_int_error, fill=system)) + 
  geom_bar(stat="identity", position=position_dodge(), colour="black") + 
  coord_cartesian(ylim = c(1, 2)) +
  ggtitle("Error ratio by month")

ggplot(data=out.s, aes(x=month, y=f_ext_error, fill=system)) + 
  geom_bar(stat="identity", position=position_dodge(), colour="black") + 
#  coord_cartesian(ylim = c(1, 2)) +
  ggtitle("Error ratio by month")

p <- qplot(tp_date_pressed, f_modern, color=system, data=out.s)
p + geom_hline(yintercept=1.0398) + geom_point() + geom_smooth(span=1) + 
  ggtitle(paste("Mean fm error vs date, ", sys, ", ", from))
```

