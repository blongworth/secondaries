---
title: "CFAMS Mass balance blank threshold"
date: "January 10, 2019"
output:
  pdf_document: default
  html_document: default
---

While looking at secondary standard data, I noticed a discontinuity in the reported error at the 100ug boundary. Below 100ug, samples get the mass balance correction for constant contamination applied to small samples.

# Data

I'm looking at all secondary standards run on CFAMS in the last two years. Data are pulled from the no_os table. I'm eliminating flyers with high sigma or measurement error.

```{r Setup, warning=FALSE, message=FALSE}

#Load Libraries
library(tidyverse)
library(amstools)
library(knitr)
 
# Set ggplot theme
theme_set(theme_bw())
#Set digits for output
options(digits=4)

#set parameters
from <- '2017-01-01'
to <- 'present' #present or date
sys <- 'cfams' #cfams, usams, ams1 or both
size <- c(0,20)
msig <- 5
mnfm <- .02
merr <- .03

#Load QC data from file
load("qcData.rda")

#Filter data
out.s <- filter(out, primary == FALSE, # rec_num != 113385, #don't use normalizing ox-I
                f_modern > .1, f_modern < 1.6,
                tp_date_pressed >= as.Date(from),
                tp_date_pressed <= ifelse(to != 'present', to, Sys.Date()),
                gf_co2_qty > size[1], gf_co2_qty < size[2], #Select size range
                lab == "OSG", #Use only samples from the SPL
                is.na(q_flag), #Check for q_flag
                abs(sigma) < msig, #Select reasonable sigmas
                abs(normFm) < mnfm, #Select reasonable Fm
                rep_err < merr
              )
```

Normalized fm difference is defined as:

$\frac{Fm_{m}-Fm_{c}}{Fm_{c}}$

where $Fm_{m}$ is measured Fm and $Fm_{c}$ is consensus Fm.


# Plots

There is no large discontinuity in fraction modern. I think this means that blank correction gives us roughly the right value with no large jump at 100ug.

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
ggplot(out.s, aes(gf_co2_qty, normFm, color = f_modern)) +
  geom_vline(color = "lightgray", xintercept=8.32) + 
  geom_hline(color = "lightgray", yintercept=0) + geom_point() +
  ggtitle("Normfm vs umol CO2")
```

Plotting the reported errors shows the largest discontinuity. Reported error jumps up below 100ug. It looks like there are a couple of curves in the MBC section. I need to look into whether this is a process thing or something else.

```{r}
ggplot(out.s, aes(gf_co2_qty, rep_err, color = f_modern)) +
geom_vline(color = "lightgray", xintercept=8.32) + geom_point() + 
  ggtitle("rep err vs umol CO2")
```

```{r}
ggplot(out.s, aes(gf_co2_qty, rep_err, color = process)) +
geom_vline(color = "lightgray", xintercept=8.32) + geom_point() + 
  ggtitle("rep err vs umol CO2")
```
This jump goes away when plotting fractional or relative reported error ($\frac{error}{Fm}$). The separate curves are still there.

```{r}
ggplot(out.s, aes(gf_co2_qty, frep_err, color = f_modern)) +
geom_vline(color = "lightgray", xintercept=8.32) + geom_point() + 
  ggtitle("fractional rep err vs umol CO2")
```

```{r}
ggplot(out.s, aes(gf_co2_qty, frep_err, color = process)) +
geom_vline(color = "lightgray", xintercept=8.32) + geom_point() + 
  ggtitle("fractional rep err vs umol CO2")
```

Is the "clean" curve on the bottom OX-I? Yes, but it's not that simple.

```{r}
filter(out.s, rec_num %in% c(34148, 113385, 133143)) %>%
ggplot(aes(gf_co2_qty, frep_err, color = sample_id)) +
geom_vline(color = "lightgray", xintercept=8.32) + geom_point() + 
  ggtitle("fractional rep err vs umol CO2")
```

# Stats

Let's look at the populations of secondaries that get MBC and those that don't separately.

```{r}
out.s <- out.s %>% mutate(small = ifelse(gf_co2_qty < 8.32, TRUE, FALSE))

out.s %>% group_by(small) %>%
  summarise(fm.m = mean(f_modern),
            nfm.m = mean(normFm),
            N = n()) %>%
  kable()
```

More modern secondaries were measured, but the populations don't look drastically different. Looks like the MBC values are closer to the expected value. 

## Accuracy

Statistical difference in normalized fraction modern. It doesn't make sense to use sigma here because the increased error from MBC correction will be the major driver. MBC data are slightly more accurate, but there's no significant difference.

```{r}
# Plot norm Fm as boxplot
ggplot(out.s, aes(small, normFm)) +
  geom_boxplot()

# Compute the analysis of variance
res.aov <- aov(normFm ~ small, data = out.s)
# Summary of the analysis
summary(res.aov) 
```

## Precision

Not very accurate, but here's reported errors just on either side of the split for both reported error and relative/fractional reported error.

```{r}
out.s %>%
  filter(gf_co2_qty < 9.02,
         gf_co2_qty > 7.62) %>%
  group_by(small) %>%
  summarise(fm.m = mean(f_modern),
            rep_err.m = mean(rep_err),
            frep_err.m = mean(frep_err),
            N = n()) %>%
  kable()
```


